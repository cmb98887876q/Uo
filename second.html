<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mock Test - Electrician</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --text: #1e293b; --success: #10b981; --danger: #ef4444; --surface: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        /* HEADER */
        .exam-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--surface); box-shadow: 0 4px 15px -5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        .close-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #f1f5f9; font-size: 1.2rem; cursor: pointer; color: #64748b; display: flex; align-items: center; justify-content: center; }
        
        /* TIMER */
        .timer-circle { width: 45px; height: 45px; border-radius: 50%; background: white; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1rem; color: var(--primary); transition: 0.3s; }
        .timer-danger { border-color: var(--danger); color: white; background: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* PROGRESS */
        .progress-container { padding: 0 20px; background: var(--surface); padding-bottom: 10px; flex-shrink: 0; }
        .progress-track { height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }

        /* CONTENT */
        .quiz-body { flex-grow: 1; padding: 20px; overflow-y: auto; width: 100%; max-width: 600px; margin: 0 auto; -webkit-overflow-scrolling: touch; }
        .q-badge { background: #e0e7ff; color: var(--primary); padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 0.75rem; display: inline-block; margin-bottom: 15px; letter-spacing: 0.5px; }
        .q-text { font-size: 1.2rem; font-weight: 700; margin: 0 0 25px; line-height: 1.5; color: var(--text); }

        /* OPTIONS */
        .options-list { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        .option-card { background: white; padding: 16px 18px; border-radius: 16px; border: 2px solid transparent; box-shadow: 0 4px 6px -2px rgba(0,0,0,0.03); cursor: pointer; display: flex; align-items: flex-start; gap: 15px; transition: transform 0.1s, background 0.2s; position: relative; overflow: hidden; }
        .option-card:active { transform: scale(0.98); background: #f8fafc; }
        .radio-circle { width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 50%; display:flex; align-items:center; justify-content:center; flex-shrink: 0; margin-top: 2px; }
        .opt-label { font-weight: 500; font-size: 0.95rem; line-height: 1.4; }

        /* FEEDBACK */
        .option-card.correct { border-color: var(--success); background: #ecfdf5; pointer-events: none; }
        .option-card.correct .radio-circle { border-color: var(--success); background: var(--success); color: white; }
        .option-card.correct .radio-circle::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.7rem; }
        .option-card.wrong { border-color: var(--danger); background: #fef2f2; pointer-events: none; }
        .option-card.wrong .radio-circle { border-color: var(--danger); background: var(--danger); color: white; }
        .option-card.wrong .radio-circle::after { content: '\f00d'; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.7rem; }
        .options-list.answered { pointer-events: none; }
        .options-list.answered .option-card { opacity: 0.6; }
        .options-list.answered .option-card.correct, .options-list.answered .option-card.wrong { opacity: 1; transform: none; }

        /* FOOTER */
        .exam-footer { background: var(--surface); padding: 15px 20px; border-top: 1px solid #f1f5f9; flex-shrink: 0; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-next { background: #e2e8f0; color: #94a3b8; pointer-events: none; }
        .btn-next.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3); pointer-events: all; }

        /* RESULT */
        #resultView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: #ecfdf5; color: #059669; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; margin-bottom: 20px; border: 6px solid #059669; box-shadow: 0 10px 20px rgba(5, 150, 105, 0.2); }
    </style>
</head>
<body>

    <header class="exam-header">
        <button class="close-btn" onclick="confirmExit()"><i class="fa-solid fa-xmark"></i></button>
        <div id="timerDisplay" class="timer-circle">60</div>
    </header>

    <div class="progress-container">
        <div class="progress-track"><div class="progress-fill" id="progressBar"></div></div>
    </div>

    <div class="quiz-body">
        <span class="q-badge" id="qCounter">QUESTION 1</span>
        <h2 class="q-text" id="qText">Loading...</h2>
        <div class="options-list" id="optionsContainer"></div>
    </div>

    <footer class="exam-footer">
        <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()">Next Question <i class="fa-solid fa-arrow-right"></i></button>
    </footer>

    <div id="resultView">
        <div class="score-circle" id="finalScore">0%</div>
        <h2 style="font-size:1.6rem; font-weight:800; margin:0 0 8px;">Test Completed!</h2>
        <p style="color:#64748b; margin:0 0 30px; font-size:0.95rem;">Score saved successfully.</p>
        <button class="btn btn-next active" style="width:100%; max-width:220px;" onclick="goBack()">Go to Dashboard</button>
    </div>

    <script>
        // FIREBASE CONFIG (Aapka original config)
        const firebaseConfig = {
            apiKey: "AIzaSyCZQoxcRbowOLLjfRcV8c0vfiTLsfc2Gys",
            authDomain: "movie-2-f1b16.firebaseapp.com",
            databaseURL: "https://movie-2-f1b16-default-rtdb.firebaseio.com",
            projectId: "movie-2-f1b16"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // QUESTIONS
        const questions = [
            { text: "What is the unit of Electric Current?", options: ["Volt", "Watt", "Ampere", "Ohm"], answer: 2 },
            { text: "Which material is the best conductor?", options: ["Gold", "Silver", "Copper", "Aluminum"], answer: 1 },
            { text: "Voltage is measured by?", options: ["Ammeter", "Voltmeter", "Ohmmeter", "Wattmeter"], answer: 1 },
            { text: "Formula for Ohm's Law?", options: ["V = I / R", "R = V x I", "V = I x R", "I = V x R"], answer: 2 },
            { text: "Frequency of DC supply?", options: ["0 Hz", "50 Hz", "60 Hz", "100 Hz"], answer: 0 }
        ];

        let currentQ = 0;
        let score = 0;
        let timeLeft = 60;
        let timerInterval;
        let isAnswered = false;

        function loadQuestion() {
            clearInterval(timerInterval);
            isAnswered = false;
            timeLeft = 60;
            
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.classList.remove('active');
            nextBtn.innerHTML = (currentQ === questions.length - 1) ? 'Finish Exam <i class="fa-solid fa-flag"></i>' : 'Next Question <i class="fa-solid fa-arrow-right"></i>';

            const container = document.getElementById('optionsContainer');
            container.classList.remove('answered');
            
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.classList.remove('timer-danger');
            
            const q = questions[currentQ];
            document.getElementById('qCounter').innerText = `QUESTION ${currentQ + 1} / ${questions.length}`;
            document.getElementById('qText').innerText = q.text;
            
            const percentage = ((currentQ + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = percentage + "%";

            container.innerHTML = '';
            q.options.forEach((opt, index) => {
                let html = `<div class="option-card" id="opt-${index}" onclick="checkAnswer(${index})">
                    <div class="radio-circle"></div><span class="opt-label">${opt}</span></div>`;
                container.innerHTML += html;
            });
            startTimer();
        }

        function startTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.innerText = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
                if(timeLeft <= 10) timerDisplay.classList.add('timer-danger');
                if(timeLeft <= 0) { clearInterval(timerInterval); autoFail(); }
            }, 1000);
        }

        function checkAnswer(selectedIndex) {
            if(isAnswered) return;
            isAnswered = true;
            clearInterval(timerInterval);
            const correctIndex = questions[currentQ].answer;
            document.getElementById('optionsContainer').classList.add('answered');

            if(selectedIndex === correctIndex) {
                score++;
                document.getElementById(`opt-${selectedIndex}`).classList.add('correct');
            } else {
                document.getElementById(`opt-${selectedIndex}`).classList.add('wrong');
                document.getElementById(`opt-${correctIndex}`).classList.add('correct');
                if(navigator.vibrate) navigator.vibrate(200);
            }
            document.getElementById('nextBtn').classList.add('active');
        }

        function autoFail() {
            if(isAnswered) return;
            isAnswered = true;
            const correctIndex = questions[currentQ].answer;
            document.getElementById('optionsContainer').classList.add('answered');
            document.getElementById(`opt-${correctIndex}`).classList.add('correct');
            document.getElementById('nextBtn').classList.add('active');
            if(navigator.vibrate) navigator.vibrate(500);
        }

        function nextQuestion() {
            if(currentQ < questions.length - 1) { currentQ++; loadQuestion(); } 
            else { submitExam(); }
        }

        function submitExam() {
            let percentage = Math.round((score / questions.length) * 100);
            document.getElementById('resultView').style.display = 'flex';
            document.getElementById('finalScore').innerText = percentage + "%";
            saveResultToFirebase(percentage);
        }

        function saveResultToFirebase(percentage) {
            // Retrieve Roll Number from index.html logic
            const roll = localStorage.getItem('iti_student_roll');
            if(roll) {
                const statsRef = db.ref('students/' + roll + '/stats');
                statsRef.once('value', (snapshot) => {
                    let currentStats = snapshot.val() || { totalTests: 0, avgScore: 0 };
                    let newTotal = currentStats.totalTests + 1;
                    let newAvg = Math.round(((currentStats.avgScore * currentStats.totalTests) + percentage) / newTotal);
                    let rank = "B";
                    if(newAvg >= 90) rank = "A+"; else if(newAvg >= 75) rank = "A";

                    statsRef.update({
                        totalTests: newTotal, avgScore: newAvg, rank: rank,
                        lastExamDate: new Date().toLocaleDateString()
                    });
                });
            } else {
                console.log("No Roll Number found, result not saved.");
            }
        }

        function confirmExit() { if(confirm("Exit Exam?")) goBack(); }
        function goBack() { window.location.href = "index.html"; }

        window.onload = loadQuestion;
    </script>
</body>
</html>