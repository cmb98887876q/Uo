<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ITI Electrician - Pro Learning</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FIREBASE SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            /* Theme Colors */
            --primary: #4f46e5;      
            --primary-light: #e0e7ff; 
            --primary-dark: #3730a3;
            --secondary: #0ea5e9;    
            --bg-body: #f8fafc;      
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            
            /* Shadows & Radius */
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-lg: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            padding-bottom: 100px; /* Base padding */
            overflow-x: hidden;
        }

        /* --- UTILS --- */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* --- HEADER --- */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 24px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50;
            border-bottom: 1px solid #e2e8f0;
        }
        .app-header.transparent { background: transparent; border: none; }
        
        .user-greeting h1 { margin: 0; font-size: 1.2rem; font-weight: 800; }
        .user-greeting span { font-size: 0.85rem; color: var(--text-sub); }
        .notification-btn { 
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;
            cursor: pointer;
        }

        /* --- LIVE EXAM BANNER --- */
        .live-exam-card {
            background: linear-gradient(135deg, #ef4444, #b91c1c); /* Red Gradient */
            margin: 20px 24px 0;
            border-radius: 16px;
            padding: 16px 20px;
            display: flex; align-items: center; justify-content: space-between;
            color: white;
            box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.4);
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.2);
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .lec-content { display: flex; align-items: center; gap: 15px; }
        .lec-icon {
            width: 45px; height: 45px; background: rgba(255,255,255,0.2);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; backdrop-filter: blur(5px);
        }
        .lec-text h4 { margin: 0 0 2px; font-size: 1rem; font-weight: 700; }
        .lec-text p { margin: 0; font-size: 0.8rem; opacity: 0.9; }
        .lec-btn {
            background: white; color: #b91c1c; border: none;
            padding: 10px 16px; border-radius: 8px; font-weight: 700; font-size: 0.85rem;
            cursor: pointer; transition: transform 0.2s; white-space: nowrap;
        }
        .lec-btn:active { transform: scale(0.95); }

        /* --- DASHBOARD HERO --- */
        .hero-section { padding: 24px; }
        .daily-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-lg); 
            padding: 24px; color: white;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
        }
        .progress-circle {
            width: 60px; height: 60px; border-radius: 50%;
            background: conic-gradient(#ffffff 75%, rgba(255,255,255,0.2) 0);
            display: flex; align-items: center; justify-content: center;
        }
        .progress-inner { 
            width: 48px; height: 48px; background: var(--primary); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 700; color: white; font-size: 0.8rem;
        }

        /* --- TABS --- */
        .tab-container { padding: 0 24px; display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .tab-btn {
            padding: 8px 18px; border-radius: 100px; border: 1px solid #e2e8f0;
            background: white; color: var(--text-sub); 
            font-size: 0.9rem; font-weight: 600; white-space: nowrap; cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active { 
            background: var(--primary); color: white; border-color: var(--primary); 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }

        /* --- MODULE CARDS --- */
        .modules-grid { padding: 0 24px; display: grid; gap: 16px; }
        .module-card {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: var(--shadow-card); border: 1px solid #f1f5f9;
            transition: transform 0.2s; cursor: pointer;
        }
        .module-card:active { transform: scale(0.98); }
        .mc-header { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; }
        .mc-icon {
            width: 50px; height: 50px; background: var(--primary-light); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.3rem; color: var(--primary); flex-shrink: 0;
        }
        .icon-red { background: #fee2e2; color: #ef4444; }
        .icon-green { background: #d1fae5; color: #10b981; }
        .mc-info h3 { margin: 0 0 4px; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .mc-info p { margin: 0; font-size: 0.9rem; color: var(--text-sub); }
        .btn-open {
            width: 100%; background: white; border: 1px solid var(--primary); color: var(--primary);
            padding: 12px; border-radius: 10px; font-weight: 600; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-open::after { content: '\f061'; font-family: "Font Awesome 6 Free"; font-weight: 900; }

        /* =========================================
           ENHANCED LEADERBOARD STYLES 
           ========================================= */
        .lb-header {
            background: var(--bg-body);
            padding: 5px 24px 0;
            position: sticky; top: 72px; 
            z-index: 40;
        }

        /* Toggle Switch */
        .lb-toggle {
            background: white; border-radius: 12px; border: 1px solid #e2e8f0;
            display: flex; padding: 4px; margin-bottom: 10px;
            box-shadow: var(--shadow-card);
        }
        .lb-toggle-btn {
            flex: 1; text-align: center; padding: 10px;
            font-size: 0.9rem; font-weight: 600; color: var(--text-sub);
            border-radius: 10px; cursor: pointer; transition: all 0.3s;
        }
        .lb-toggle-btn.active {
            background: var(--primary); color: white;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        /* Podium Section */
        .podium-container {
            display: flex; align-items: flex-end; justify-content: center;
            gap: 15px; padding: 30px 0 50px;
            background: radial-gradient(circle at center, rgba(79, 70, 229, 0.08) 0%, transparent 70%);
            min-height: 220px;
        }

        .podium-item {
            display: flex; flex-direction: column; align-items: center;
            position: relative; width: 90px;
        }

        .podium-avatar {
            width: 60px; height: 60px; border-radius: 50%;
            background-size: cover; background-position: center;
            border: 3px solid white;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            position: relative; z-index: 2;
            transition: transform 0.3s;
            background-color: #ddd;
        }

        .podium-rank {
            position: absolute; top: -10px;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; font-weight: 800; color: white;
            z-index: 3; border: 2px solid white;
        }

        .podium-info { text-align: center; margin-top: 12px; }
        .podium-name { font-size: 0.85rem; font-weight: 700; color: var(--text-main); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;}
        .podium-score { font-size: 0.75rem; font-weight: 600; color: var(--primary); background: white; padding: 2px 8px; border-radius: 10px; border: 1px solid #e2e8f0; margin-top: 4px; display: inline-block;}

        .winner { transform: translateY(-20px) scale(1.15); z-index: 5; }
        .winner .podium-avatar { border-color: #fbbf24; box-shadow: 0 0 25px rgba(251, 191, 36, 0.4); }
        .winner .podium-rank { background: #fbbf24; }
        .winner .crown-icon {
            position: absolute; top: -28px; font-size: 1.5rem; color: #fbbf24;
            animation: bounce 2s infinite;
        }

        .runner-up .podium-avatar { border-color: #94a3b8; }
        .runner-up .podium-rank { background: #94a3b8; }
        .third-place .podium-avatar { border-color: #b45309; }
        .third-place .podium-rank { background: #b45309; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

        /* Leaderboard List */
        .lb-list { 
            padding: 0 24px; 
            /* CRITICAL FIX: Large bottom padding so sticky card doesn't hide last student */
            padding-bottom: 200px; 
        }
        
        .lb-card {
            display: flex; align-items: center; padding: 12px 16px;
            background: white; border-radius: 16px; margin-bottom: 12px;
            box-shadow: var(--shadow-card); border: 1px solid #f1f5f9;
        }
        .lb-rank-num { width: 30px; font-weight: 700; color: var(--text-sub); font-size: 0.95rem; }
        .lb-user-img { width: 42px; height: 42px; border-radius: 50%; background-size: cover; margin-right: 15px; background-color: #e2e8f0;}
        .lb-details { flex: 1; }
        .lb-details h4 { margin: 0 0 2px; font-size: 0.95rem; font-weight: 700; color: var(--text-main); }
        .lb-details span { font-size: 0.75rem; color: var(--text-sub); }
        .lb-points { font-weight: 800; font-size: 0.9rem; color: var(--text-main); display: flex; flex-direction: column; align-items: flex-end;}
        .trend { font-size: 0.65rem; display: flex; align-items: center; gap: 3px; margin-top: 2px; }
        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }
        .trend.neutral { color: #94a3b8; }

        /* Sticky User Card */
        .sticky-user-rank {
            position: fixed; 
            bottom: 95px; /* Above Bottom Nav (20px + ~60px height + spacing) */
            left: 20px; right: 20px;
            background: #1e1b4b; /* Dark Navy */
            color: white;
            border-radius: 20px; padding: 12px 20px;
            display: flex; align-items: center;
            box-shadow: 0 15px 30px -5px rgba(0,0,0,0.4);
            z-index: 95; /* Higher than Nav */
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sticky-user-rank .lb-rank-num { color: rgba(255,255,255,0.7); }
        .sticky-user-rank .lb-details h4 { color: white; margin: 0 0 2px; font-size: 0.95rem; font-weight: 700; }
        .sticky-user-rank .lb-details span { color: rgba(255,255,255,0.6); font-size: 0.75rem; }
        .sticky-user-rank .lb-points { color: #fbbf24; font-weight: 800; }
        
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }


        /* --- PROFILE VIEW --- */
        .profile-wrapper { position: relative; background: var(--bg-body); min-height: 100vh; }
        .profile-banner {
            height: 180px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            position: relative; display: flex; justify-content: space-between; padding: 20px 24px; color: white;
        }
        .banner-title { font-size: 1.2rem; font-weight: 700; margin-top: 10px; }
        .btn-back-profile { 
            color: white; font-size: 1.2rem; cursor: pointer; 
            background: rgba(255,255,255,0.2); width: 40px; height: 40px; margin-top: 5px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .profile-main-card {
            background: white; margin: -80px 20px 20px 20px;
            border-radius: 24px; padding: 0 20px 25px 20px;
            box-shadow: var(--shadow-float); position: relative; text-align: center;
        }
        .profile-avatar-container { position: relative; display: inline-block; margin-top: -50px; margin-bottom: 10px; }
        .p-avatar-img {
            width: 100px; height: 100px; border-radius: 50%;
            background-image: url('https://img.freepik.com/free-psd/3d-illustration-human-avatar-profile_23-2150671142.jpg');
            background-size: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .edit-badge {
            position: absolute; bottom: 5px; right: 0; background: var(--text-main); color: white;
            width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; border: 2px solid white;
        }
        .profile-name { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin: 5px 0 0; }
        .profile-role { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 15px; }
        .id-pill {
            display: inline-block; background: #f1f5f9; color: var(--text-sub); font-weight: 600; font-size: 0.8rem;
            padding: 6px 14px; border-radius: 20px; font-family: monospace;
        }
        .profile-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 25px; border-top: 1px solid #f1f5f9; padding-top: 20px; }
        .p-stat-item { display: flex; flex-direction: column; gap: 4px; }
        .p-stat-val { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .p-stat-label { font-size: 0.75rem; color: var(--text-sub); font-weight: 600; text-transform: uppercase; }
        
        .menu-section { padding: 0 24px 20px; }
        .menu-title { font-size: 0.95rem; font-weight: 700; color: var(--text-sub); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .menu-list { display: flex; flex-direction: column; gap: 12px; }
        .menu-item {
            background: white; padding: 16px; border-radius: 16px; display: flex; align-items: center; gap: 15px;
            box-shadow: var(--shadow-card); transition: transform 0.2s; cursor: pointer;
        }
        .menu-item:active { transform: scale(0.98); background: #f8fafc; }
        .menu-icon {
            width: 40px; height: 40px; border-radius: 10px; background: var(--bg-body); color: var(--text-main);
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
        }
        .menu-text { flex: 1; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .menu-arrow { color: #cbd5e1; }
        .mi-blue { background: #eff6ff; color: var(--primary); }
        .mi-purple { background: #f5f3ff; color: #7c3aed; }
        .mi-red { background: #fef2f2; color: #ef4444; }


        /* --- FLOATING NAV --- */
        .bottom-nav-container {
            position: fixed; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; z-index: 100;
        }
        .bottom-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 12px 30px; border-radius: 30px;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 35px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-item { color: #94a3b8; font-size: 1.3rem; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }


        /* --- POPUP MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-card {
            background: white; width: 85%; max-width: 320px;
            padding: 30px 24px; border-radius: 24px;
            text-align: center;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .modal-overlay.active .modal-card { transform: translateY(0); }
        .input-group { margin: 15px 0 10px; text-align: left; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; }
        .custom-input {
            width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0;
            border-radius: 12px; font-size: 1rem; font-weight: 600;
            color: var(--text-main); outline: none; transition: 0.2s; background: #f8fafc;
        }
        .custom-input:focus { border-color: var(--primary); background: white; }
        .btn-submit {
            background: var(--primary); color: white; border: none;
            width: 100%; padding: 15px; border-radius: 12px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); margin-top: 15px;
            transition: transform 0.1s;
        }
        .btn-submit:active { transform: scale(0.96); }

    </style>
</head>
<body>

    <!-- =========================
         1. DASHBOARD (HOME) VIEW
         ========================= -->
    <div id="dashboardView" class="fade-in">
        <header class="app-header">
            <div class="user-greeting">
                <span>Welcome back,</span>
                <h1 id="homeUserName">Student</h1>
            </div>
            <div class="notification-btn"><i class="fa-regular fa-bell"></i></div>
        </header>

        <!-- LIVE EXAM ALERT (Hidden by default) -->
        <div id="liveExamContainer" class="hidden">
            <div class="live-exam-card">
                <div class="lec-content">
                    <div class="lec-icon">
                        <i class="fa-solid fa-stopwatch fa-beat"></i>
                    </div>
                    <div class="lec-text">
                        <h4 id="examTitle">Exam Started!</h4>
                        <p>Click join to start now.</p>
                    </div>
                </div>
                <button class="lec-btn" onclick="joinLiveExam()">JOIN</button>
            </div>
        </div>

        <div class="hero-section">
            <div class="daily-card">
                <div class="daily-text">
                    <h3 style="margin:0 0 5px;">Daily Goal</h3>
                    <p style="margin:0; opacity:0.9">Keep the streak alive! ðŸ”¥</p>
                </div>
                <div class="progress-circle">
                    <div class="progress-inner">75%</div>
                </div>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn active">All</button>
            <button class="tab-btn">1st Year</button>
            <button class="tab-btn">2nd Year</button>
        </div>

        <div class="modules-grid">
            
            <!-- ELECTRICIAN THEORY CARD (UPDATED to open second.html) -->
            <div class="module-card" onclick="openSubjectPage('second.html')">
                <div class="mc-header">
                    <div class="mc-icon"><i class="fa-solid fa-bolt"></i></div>
                    <div class="mc-info">
                        <h3>Electrician Theory</h3>
                        <p>Complete Syllabus</p>
                    </div>
                </div>
                <button class="btn-open">View Chapters</button>
            </div>

            <!-- WORKSHOP CARD -->
            <div class="module-card" onclick="openSubjectPage('workshop.html')">
                <div class="mc-header">
                    <div class="mc-icon icon-red"><i class="fa-solid fa-gears"></i></div>
                    <div class="mc-info">
                        <h3>Workshop Calculation</h3>
                        <p>Maths & Physics</p>
                    </div>
                </div>
                <button class="btn-open">View Chapters</button>
            </div>

            <!-- EMPLOYABILITY CARD -->
            <div class="module-card" onclick="openSubjectPage('employability.html')">
                <div class="mc-header">
                    <div class="mc-icon icon-green"><i class="fa-solid fa-comments"></i></div>
                    <div class="mc-info">
                        <h3>Employability Skills</h3>
                        <p>Soft Skills & IT</p>
                    </div>
                </div>
                <button class="btn-open">View Chapters</button>
            </div>
        </div>
    </div>


    <!-- =========================
         2. LEADERBOARD VIEW
         ========================= -->
    <div id="statsView" class="hidden fade-in">
        <header class="app-header transparent">
            <div class="user-greeting">
                <h1>Leaderboard</h1>
                <span>Electrician Batch 2024</span>
            </div>
            <div class="notification-btn" onclick="switchTab('home')">
                <i class="fa-solid fa-xmark"></i>
            </div>
        </header>

        <div class="lb-header">
            <div class="lb-toggle">
                <div class="lb-toggle-btn active" onclick="updateLeaderboard('weekly', this)">Weekly</div>
                <div class="lb-toggle-btn" onclick="updateLeaderboard('alltime', this)">All Time</div>
            </div>
        </div>

        <!-- PODIUM (Top 3) - Content Filled by JS -->
        <div class="podium-container" id="podiumContainer">
            <!-- JS injects here -->
        </div>

        <!-- LIST (Rank 4+) - Content Filled by JS -->
        <div class="lb-list" id="lbListContainer">
            <!-- JS injects here -->
        </div>

        <!-- STICKY USER CARD - Content Filled by JS -->
        <div class="sticky-user-rank hidden" id="stickyUserRank">
            <!-- JS injects here -->
        </div>
    </div>


    <!-- =========================
         3. PROFILE VIEW
         ========================= -->
    <div id="profileView" class="profile-wrapper hidden fade-in">
        <div class="profile-banner">
            <div class="btn-back-profile" onclick="switchTab('home')">
                <i class="fa-solid fa-arrow-left"></i>
            </div>
            <div class="banner-title">My Profile</div>
            <div class="btn-back-profile" style="background:transparent; pointer-events:none;"></div>
        </div>
        <div class="profile-main-card">
            <div class="profile-avatar-container">
                <div class="p-avatar-img"></div>
                <div class="edit-badge"><i class="fa-solid fa-camera"></i></div>
            </div>
            <h2 class="profile-name" id="profileName">Student</h2>
            <p class="profile-role">ITI Electrician â€¢ 1st Year</p>
            <div class="id-pill" id="profileRoll">ID: ----</div>
            
            <!-- Default stats are 0, updated from DB -->
            <div class="profile-stats-grid">
                <div class="p-stat-item"><span class="p-stat-val" id="profileTests">0</span><span class="p-stat-label">Tests</span></div>
                <div class="p-stat-item"><span class="p-stat-val" id="profileAvg">0%</span><span class="p-stat-label">Avg Score</span></div>
                <div class="p-stat-item"><span class="p-stat-val" id="profileRank">--</span><span class="p-stat-label">Rank</span></div>
            </div>
        </div>
        <div class="menu-section">
            <div class="menu-title">Account Settings</div>
            <div class="menu-list">
                <div class="menu-item">
                    <div class="menu-icon mi-blue"><i class="fa-regular fa-user"></i></div>
                    <div class="menu-text">Personal Information</div>
                    <div class="menu-arrow"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <div class="menu-item">
                    <div class="menu-icon mi-purple"><i class="fa-solid fa-chart-simple"></i></div>
                    <div class="menu-text">My Progress Report</div>
                    <div class="menu-arrow"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <div class="menu-item">
                    <div class="menu-icon"><i class="fa-solid fa-shield-halved"></i></div>
                    <div class="menu-text">Privacy & Security</div>
                    <div class="menu-arrow"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <div class="menu-item" style="margin-top:10px;">
                    <div class="menu-icon mi-red"><i class="fa-solid fa-arrow-right-from-bracket"></i></div>
                    <div class="menu-text" style="color:#ef4444;" onclick="logout()">Logout / Reset</div>
                </div>
            </div>
        </div>
    </div>


    <!-- =========================
         BOTTOM NAVIGATION
         ========================= -->
    <div class="bottom-nav-container">
        <nav class="bottom-nav">
            <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
                <i class="fa-solid fa-house-chimney"></i>
            </div>
            <div class="nav-item">
                <i class="fa-solid fa-book-open"></i>
            </div>
            <!-- PIE CHART ICON (Triggers Leaderboard) -->
            <div class="nav-item" id="nav-stats" onclick="switchTab('stats')">
                <i class="fa-solid fa-trophy"></i>
            </div>
            <div class="nav-item" id="nav-profile" onclick="switchTab('profile')">
                <i class="fa-regular fa-user"></i>
            </div>
        </nav>
    </div>

    <!-- =========================
         WELCOME / LOGIN POPUP
         ========================= -->
    <div id="welcomeModal" class="modal-overlay">
        <div class="modal-card">
            <div class="mc-icon" style="margin: 0 auto 15px; width:60px; height:60px; font-size:1.5rem;">
                <i class="fa-solid fa-user-graduate"></i>
            </div>
            <h2 style="margin:0 0 5px; font-size:1.5rem;">Welcome!</h2>
            <p style="margin:0 0 10px; color:var(--text-sub); font-size:0.9rem;">Enter your details to get started.</p>
            
            <div class="input-group">
                <label class="input-label">Student Name</label>
                <input type="text" id="modalName" class="custom-input" placeholder="Ex. Rahul Sharma">
            </div>
            
            <div class="input-group">
                <label class="input-label">Roll Number</label>
                <input type="tel" id="modalRoll" class="custom-input" placeholder="Ex. 2024-001">
            </div>

            <button class="btn-submit" onclick="submitLogin()">Start Learning</button>
        </div>
    </div>


    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCZQoxcRbowOLLjfRcV8c0vfiTLsfc2Gys",
            authDomain: "movie-2-f1b16.firebaseapp.com",
            databaseURL: "https://movie-2-f1b16-default-rtdb.firebaseio.com",
            projectId: "movie-2-f1b16"
        };
        
        // Initialize Firebase
        let db; // Global DB variable
        if(typeof firebase !== 'undefined'){
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase Connected");
        }

        // --- 2. GLOBAL VARIABLES ---
        let currentUserName = "Student"; 
        const currentUserAvatar = "https://img.freepik.com/free-psd/3d-illustration-human-avatar-profile_23-2150671142.jpg";
        let liveExamUrl = "";


        // --- 3. LOGIN / POPUP LOGIC ---
        window.addEventListener('load', () => {
            // Check if user data exists in Local Storage
            const storedName = localStorage.getItem('iti_student_name');
            const storedRoll = localStorage.getItem('iti_student_roll');
            
            if(!storedName || !storedRoll) {
                // Show Modal if no data
                setTimeout(() => {
                    document.getElementById('welcomeModal').classList.add('active');
                }, 500); 
            } else {
                // Update UI if data exists
                updateUserUI(storedName, storedRoll);
            }

            // Start Listening for Exams
            initExamListener();
        });

        function submitLogin() {
            const name = document.getElementById('modalName').value.trim();
            const roll = document.getElementById('modalRoll').value.trim();
            
            if(name && roll) {
                // A. Save to LocalStorage (Browser Memory)
                localStorage.setItem('iti_student_name', name);
                localStorage.setItem('iti_student_roll', roll);
                
                // B. SAVE TO FIREBASE DATABASE (Online)
                if(db) {
                    db.ref('students/' + roll).set({
                        name: name,
                        roll: roll,
                        joined: new Date().toLocaleString(),
                        device: navigator.userAgent
                    }).then(() => {
                        console.log("Registered in Database");
                    }).catch((error) => {
                        console.error("Error saving data: ", error);
                    });
                }
                
                // C. Update App UI
                updateUserUI(name, roll);
                
                // D. Close Modal
                document.getElementById('welcomeModal').classList.remove('active');
            } else {
                alert("Please enter both Name and Roll Number to continue.");
            }
        }

        function updateUserUI(name, roll) {
            currentUserName = name;
            // Home Header
            document.getElementById('homeUserName').textContent = name;
            // Profile Page Name
            document.getElementById('profileName').textContent = name;
            document.getElementById('profileRoll').textContent = "ID: " + roll;

            // --- FETCH STATS FROM FIREBASE (FROM EXAM PAGE) ---
            if(db) {
                db.ref('students/' + roll + '/stats').on('value', (snapshot) => {
                    const stats = snapshot.val();
                    if(stats) {
                        // If stats exist in database, update UI
                        document.getElementById('profileTests').textContent = stats.totalTests || "0";
                        document.getElementById('profileAvg').textContent = (stats.avgScore || "0") + "%";
                        document.getElementById('profileRank').textContent = stats.rank || "--";
                    } else {
                        // Keep as 0 if no results found
                        document.getElementById('profileTests').textContent = "0";
                        document.getElementById('profileAvg').textContent = "0%";
                        document.getElementById('profileRank').textContent = "--";
                    }
                });
            }
        }

        function logout() {
            if(confirm("Are you sure you want to reset your details?")) {
                localStorage.removeItem('iti_student_name');
                localStorage.removeItem('iti_student_roll');
                location.reload();
            }
        }


        // --- 4. EXAM LISTENER LOGIC ---
        function initExamListener() {
            if(!db) return;

            // Listen to 'active_exam' node
            db.ref('active_exam').on('value', (snapshot) => {
                const data = snapshot.val();
                const banner = document.getElementById('liveExamContainer');
                const titleEl = document.getElementById('examTitle');

                if (data && data.isRunning === true) {
                    // Show Banner
                    banner.classList.remove('hidden');
                    // Update Details
                    titleEl.textContent = data.examName || "Live Exam Started!";
                    liveExamUrl = data.examLink || "#";
                    // Vibration alert
                    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                } else {
                    // Hide Banner
                    banner.classList.add('hidden');
                }
            });
        }

        function joinLiveExam() {
            if(liveExamUrl && liveExamUrl !== "#") {
                window.location.href = liveExamUrl;
            } else {
                alert("Exam link is not valid.");
            }
        }


        // --- 5. LEADERBOARD DATA & LOGIC ---
        const studentNames = [
            "Amit Verma", "Priya Singh", "Rahul Sharma", "Vikram Kumar", "Neha Gupta", 
            "Arjun Singh", "Sita Verma", "Mohd Rizwan", "John Doe", "Kavita Rao", 
            "Suresh Raina", "Deepak Patel", "Anjali Mehta", "Rajesh Koothrappali", 
            "Sneha Reddy", "Ishaan Awasthi", "Kabir Singh", "Preeti S"
        ];

        function generateData(type) {
            let data = studentNames.map((name, index) => {
                let gender = index % 2 === 0 ? 'men' : 'women';
                let imgId = (index % 70) + 1; 
                let avatar = `https://randomuser.me/api/portraits/${gender}/${imgId}.jpg`;
                
                let baseScore = type === 'weekly' ? 800 : 2500;
                let randomVariance = Math.floor(Math.random() * 400);
                if(index === 0) randomVariance += 150;

                return {
                    name: name,
                    section: "Sec A",
                    score: baseScore + randomVariance,
                    avatar: avatar,
                    trend: Math.random() > 0.5 ? 'up' : 'down',
                    trendVal: Math.floor(Math.random() * 5) + 1
                };
            });

            // Ensure current user is in the list
            let userExists = data.find(d => d.name === currentUserName);
            if(!userExists) {
                data.push({
                    name: currentUserName,
                    section: "Sec A",
                    score: type === 'weekly' ? 950 : 2800,
                    avatar: currentUserAvatar,
                    trend: 'up',
                    trendVal: 2
                });
            }

            // Sort by Score Descending
            return data.sort((a, b) => b.score - a.score);
        }

        // Render to HTML
        function renderLeaderboard(data) {
            const podiumEl = document.getElementById('podiumContainer');
            const listEl = document.getElementById('lbListContainer');
            const stickyEl = document.getElementById('stickyUserRank');

            if (!podiumEl || !listEl) return;

            podiumEl.innerHTML = '';
            listEl.innerHTML = '';

            // Rank 2
            if(data[1]) {
                podiumEl.innerHTML += `
                <div class="podium-item runner-up fade-in" style="animation-delay: 0.1s">
                    <div class="podium-rank">2</div>
                    <div class="podium-avatar" style="background-image: url('${data[1].avatar}')"></div>
                    <div class="podium-info">
                        <span class="podium-name">${data[1].name.split(' ')[0]}</span>
                        <div class="podium-score">${data[1].score} XP</div>
                    </div>
                </div>`;
            }

            // Rank 1
            if(data[0]) {
                podiumEl.innerHTML += `
                <div class="podium-item winner fade-in">
                    <i class="fa-solid fa-crown crown-icon"></i>
                    <div class="podium-rank">1</div>
                    <div class="podium-avatar" style="background-image: url('${data[0].avatar}')"></div>
                    <div class="podium-info">
                        <span class="podium-name">${data[0].name.split(' ')[0]}</span>
                        <div class="podium-score">${data[0].score} XP</div>
                    </div>
                </div>`;
            }

            // Rank 3
            if(data[2]) {
                podiumEl.innerHTML += `
                <div class="podium-item third-place fade-in" style="animation-delay: 0.2s">
                    <div class="podium-rank">3</div>
                    <div class="podium-avatar" style="background-image: url('${data[2].avatar}')"></div>
                    <div class="podium-info">
                        <span class="podium-name">${data[2].name.split(' ')[0]}</span>
                        <div class="podium-score">${data[2].score} XP</div>
                    </div>
                </div>`;
            }

            // Rank 4 to End
            for(let i = 3; i < data.length; i++) {
                let student = data[i];
                let trendIcon = student.trend === 'up' ? '<i class="fa-solid fa-arrow-up"></i>' : '<i class="fa-solid fa-arrow-down"></i>';
                
                let html = `
                <div class="lb-card fade-in" style="animation-delay: 0.05s">
                    <div class="lb-rank-num">${i+1}</div>
                    <div class="lb-user-img" style="background-image: url('${student.avatar}')"></div>
                    <div class="lb-details">
                        <h4>${student.name}</h4>
                        <span>${student.section}</span>
                    </div>
                    <div class="lb-points">
                        ${student.score}
                        <div class="trend ${student.trend}">${trendIcon} ${student.trendVal}</div>
                    </div>
                </div>`;
                listEl.innerHTML += html;
            }

            // Sticky User Card
            let myRankIndex = data.findIndex(s => s.name === currentUserName);
            if(myRankIndex !== -1) {
                let me = data[myRankIndex];
                stickyEl.innerHTML = `
                <div class="lb-rank-num" style="color:rgba(255,255,255,0.7)">${myRankIndex + 1}</div>
                <div class="lb-user-img" style="background-image: url('${me.avatar}'); border: 2px solid white;"></div>
                <div class="lb-details">
                    <h4 style="color:white">${me.name} (You)</h4>
                    <span style="color:rgba(255,255,255,0.6)">${me.section} â€¢ Top ${(myRankIndex/data.length*100).toFixed(0)}%</span>
                </div>
                <div class="lb-points" style="color:#fbbf24">
                    ${me.score} XP
                </div>`;
                stickyEl.classList.remove('hidden');
            } else {
                stickyEl.classList.add('hidden');
            }
        }

        // Controller
        function updateLeaderboard(type, btnElement) {
            if(btnElement) {
                document.querySelectorAll('.lb-toggle-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            const list = document.querySelector('.lb-list');
            const podium = document.querySelector('.podium-container');
            
            if(list && podium) {
                list.style.opacity = '0.5';
                podium.style.opacity = '0.5';
                setTimeout(() => {
                    const newData = generateData(type);
                    renderLeaderboard(newData);
                    list.style.opacity = '1';
                    podium.style.opacity = '1';
                }, 150);
            } else {
                const newData = generateData(type);
                renderLeaderboard(newData);
            }
        }

        // --- 6. NAVIGATION CONTROLLER ---
        const dashboardView = document.getElementById('dashboardView');
        const profileView = document.getElementById('profileView');
        const statsView = document.getElementById('statsView');
        
        const navHome = document.getElementById('nav-home');
        const navProfile = document.getElementById('nav-profile');
        const navStats = document.getElementById('nav-stats');

        function switchTab(tabName) {
            dashboardView.classList.add('hidden');
            profileView.classList.add('hidden');
            statsView.classList.add('hidden');
            
            navHome.classList.remove('active');
            navProfile.classList.remove('active');
            navStats.classList.remove('active');

            window.scrollTo(0,0);

            if (tabName === 'home') {
                dashboardView.classList.remove('hidden');
                navHome.classList.add('active');

            } else if (tabName === 'profile') {
                profileView.classList.remove('hidden');
                navProfile.classList.add('active');

            } else if (tabName === 'stats') {
                statsView.classList.remove('hidden');
                navStats.classList.add('active');
                
                if(document.getElementById('lbListContainer').innerHTML.trim() === "") {
                    const firstBtn = document.querySelector('.lb-toggle-btn');
                    updateLeaderboard('weekly', firstBtn);
                }
            }
        }

        // --- LINK OPENER FUNCTION ---
        function openSubjectPage(url) {
            if(url && url !== '#') {
                window.location.href = url;
            } else {
                console.log("No link provided");
            }
        }
    </script>
</body>
</html>